<!DOCTYPE html>
<html>
<head>
  <title>Audio Spectrum Analyzer</title>
  <link rel="manifest" href="manifest.json">
  
  <!-- iOS specific meta tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Spectrum">
  <link rel="apple-touch-icon" href="../images/favicon-32x32.png">
  
  <!-- Standard meta tags -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#4CAF50">
  
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background-color: #222;
      color: #eee;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #container {
      width: calc(100vw - 80px);
      max-width: 100vw;
      padding: 0 20px;
      box-sizing: border-box;
    }

    h1 {
      margin-bottom: 20px;
      text-align: center;
    }

    canvas {
      border: 1px solid #555;
      background-color: #333;
      /* width: 100%;
      height: 400px; */
      display: block;
    }

    #controls {
        margin-top: 20px;
        margin-bottom: 10px;
        display: flex;
        gap: 10px;
        align-items: center;
    }

    #spectrumContainer {
      display: flex;
      align-items: flex-start;
      width: 100%;
    }

    #freqScaleCanvas {
      width: 40px;
      height: 400px;
      display: block;
    }

    .green-btn {
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      margin: 0 auto;
      display: block;
      transition: background 0.2s;
    }
    .green-btn:hover {
      background-color: #388e3c;
    }
    
    .install-btn {
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
      display: none;
    }
    .install-btn:hover {
      background-color: #1976D2;
    }
    
    .install-btn.show {
      display: inline-block;
    }
    
    .ios-install-instructions {
      display: none;
      background-color: #333;
      border: 1px solid #555;
      border-radius: 8px;
      padding: 16px;
      margin-top: 10px;
      font-size: 14px;
      line-height: 1.4;
    }
    
    .ios-install-instructions.show {
      display: block;
    }
    
    .close-btn {
      background-color: #666;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
      float: right;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div id="container">
    <h1>Audio Spectrum Analyzer</h1>

    <div id="controls">
      <button id="startButton" class="green-btn">Start Analysis</button>
      <button id="installButton" class="install-btn">ðŸ“± Install App</button>
    </div>

    <div id="iosInstructions" class="ios-install-instructions">
      <button class="close-btn" onclick="document.getElementById('iosInstructions').classList.remove('show')">Ã—</button>
      <strong>Install on iOS:</strong><br>
      1. Tap the Share button (â–¡â†—) in Safari<br>
      2. Scroll down and tap "Add to Home Screen"<br>
      3. Tap "Add" to install the app
    </div>

    <div id="spectrumContainer">
      <canvas id="spectrumCanvas"></canvas>
      <canvas id="freqScaleCanvas" width="40" height="400"></canvas>
    </div>
  </div>

  <script>
    // PWA Install functionality
    let deferredPrompt;
    const installButton = document.getElementById('installButton');
    const iosInstructions = document.getElementById('iosInstructions');

    // Check if device is iOS
    function isIOS() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    }

    // Check if app is already installed (running in standalone mode)
    function isInstalled() {
      return window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
    }

    // Show appropriate install option
    function showInstallOption() {
      if (isInstalled()) {
        // App is already installed, don't show install button
        return;
      }

      if (isIOS()) {
        // Show install button that will show iOS instructions
        installButton.classList.add('show');
        installButton.textContent = 'ðŸ“± Install App (iOS)';
        installButton.addEventListener('click', () => {
          iosInstructions.classList.add('show');
        });
      } else {
        // For other browsers, show install button if PWA prompt is available
        if (deferredPrompt) {
          installButton.classList.add('show');
          installButton.addEventListener('click', () => {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
              if (choiceResult.outcome === 'accepted') {
                console.log('User accepted the install prompt');
                installButton.classList.remove('show');
              }
              deferredPrompt = null;
            });
          });
        }
      }
    }

    // Listen for the beforeinstallprompt event
    window.addEventListener('beforeinstallprompt', (e) => {
      // Prevent the mini-infobar from appearing on mobile
      e.preventDefault();
      // Stash the event so it can be triggered later
      deferredPrompt = e;
      showInstallOption();
    });

    // Initialize install functionality when page loads
    window.addEventListener('load', () => {
      showInstallOption();
    });

    // Main app script
    const canvas = document.getElementById('spectrumCanvas');
    const ctx = canvas.getContext('2d');
    const freqScaleCanvas = document.getElementById('freqScaleCanvas');
    const freqScaleCtx = freqScaleCanvas.getContext('2d');

    // Set canvas size to full width and double height (responsive)
    function resizeCanvas() {
      const container = document.getElementById('container');
      canvas.width = container.clientWidth - freqScaleCanvas.width;
      canvas.height = 400;
      freqScaleCanvas.height = 400;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    let audioContext;
    let analyser;
    let microphone;
    let isRecording = false; // Flag to control recording state
    let bufferHistory = [];  // Store past frames for waterfall effect
    const historyLength = 100; // Number of frames to keep in the history

    document.getElementById('startButton').addEventListener('click', toggleRecording);
    document.addEventListener('keyup', function(e) {
      if (e.code === 'Space' || e.key === ' ') {
        toggleRecording();
      }
    });
    document.getElementById('spectrumContainer').addEventListener('click', function() {
      toggleRecording();
    });


    function init() {
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048; // Increased FFT size for better resolution
        analyser.smoothingTimeConstant = 0.8;  // Smooth the data

      } catch (e) {
        alert('Web Audio API is not supported in this browser.');
        return;
      }
    }


    function getUserMedia() {
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          const mediaStreamSource = audioContext.createMediaStreamSource(stream);
          mediaStreamSource.connect(analyser);
          return mediaStreamSource;
        })
        .catch(err => {
          alert('Error accessing microphone: ' + err);
        });
    }

    function toggleRecording() {
      if (!isRecording) {
        startRecording();
      } else {
        stopRecording();
      }
    }


    function startRecording() {
      init(); // Ensure initialization happens before starting
      getUserMedia();
      isRecording = true;
      document.getElementById('startButton').textContent = 'Stop Analysis';

      bufferHistory = [];  // Clear the history when restarting

      draw();
    }

    function stopRecording() {
      if (audioContext && audioContext.state === 'running') {
        audioContext.close(); // Close the AudioContext to release resources
      }
      isRecording = false;
      document.getElementById('startButton').textContent = 'Start Analysis';
    }


    function drawFrequencyScale() {
      freqScaleCtx.clearRect(0, 0, freqScaleCanvas.width, freqScaleCanvas.height);
      freqScaleCtx.save();
      freqScaleCtx.fillStyle = 'black';
      freqScaleCtx.fillRect(0, 0, freqScaleCanvas.width, freqScaleCanvas.height);
      freqScaleCtx.font = '12px sans-serif';
      freqScaleCtx.fillStyle = '#eee';
      freqScaleCtx.strokeStyle = '#eee';
      freqScaleCtx.textAlign = 'left';
      const logMin = Math.log10(20);
      const logMax = Math.log10(20000);
      const freqsToMark = [20, 50, 100, 200, 500, 1000, 2000, 5000, 10000, 20000];
      for (const freq of freqsToMark) {
        const logFreq = Math.log10(freq);
        const y = freqScaleCanvas.height - 1 - Math.round((logFreq - logMin) / (logMax - logMin) * (freqScaleCanvas.height - 1));
        // Tick mark
        freqScaleCtx.beginPath();
        freqScaleCtx.moveTo(0, y);
        freqScaleCtx.lineTo(10, y);
        freqScaleCtx.stroke();
        const offsetY = freq === 20 ? -1 : freq === 20000 ? 11 :  4;
        freqScaleCtx.fillText(freq >= 1000 ? (freq/1000)+'k' : freq, 12, y + offsetY);
      }
      freqScaleCtx.restore();
    }

    function draw() {
      if (!isRecording || !audioContext) return;

      // Get frequency data
      const dataArray = new Uint8Array(analyser.frequencyBinCount);
      analyser.getByteFrequencyData(dataArray);

      // Scroll the canvas left by 1 pixel
      const imageData = ctx.getImageData(1, 0, canvas.width - 1, canvas.height);
      ctx.putImageData(imageData, 0, 0);
      // Clear the rightmost column
      ctx.clearRect(canvas.width - 1, 0, 1, canvas.height);

      // Draw the new spectrum as a vertical line on the right
      const numFreqs = analyser.frequencyBinCount;
      function getColor(value) {
        const normalizedValue = value / 255;
        if (normalizedValue < 0.1) return 'black';
        else if (normalizedValue < 0.2) return 'blue';
        else if (normalizedValue < 0.4) return 'green';
        else if (normalizedValue < 0.6) return 'yellow';
        else if (normalizedValue < 0.8) return 'orange';
        else if (normalizedValue < 0.9) return 'purple';
        else return 'red';
      }

      for (let i = 0; i < numFreqs; i++) {
        // Map frequency bin to vertical pixel (logarithmic scale)
        const logMin = Math.log10(20);
        const logMax = Math.log10(20000);
        const logFreq = logMin + (i / (numFreqs - 1)) * (logMax - logMin);
        const y = canvas.height - 1 - Math.round((logFreq - logMin) / (logMax - logMin) * (canvas.height - 1));
        const color = getColor(dataArray[i]);
        ctx.fillStyle = color;
        ctx.fillRect(canvas.width - 1, y, 1, 1);
      }

      requestAnimationFrame(draw);
    }

    window.addEventListener('resize', () => {
      resizeCanvas();
      drawFrequencyScale();
    });
    resizeCanvas();
    drawFrequencyScale();
  </script>
</body>
</html>
